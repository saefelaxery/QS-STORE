@model List<LaLaStore.Models.CartItem>
@{
    ViewData["Title"] = "Shopping Cart";
    var totalPrice = ViewBag.TotalPrice as decimal? ?? 0;
}

<div class="container my-5">
    <h1 class="fw-bold mb-4">Shopping Cart</h1>

    @if (Model.Count == 0)
    {
        <div class="text-center py-5">
            <i class="bi bi-cart-x" style="font-size: 4rem; color: #ccc;"></i>
            <p class="text-muted mt-3 mb-4">Your cart is empty</p>
            <a asp-controller="Products" asp-action="Index" class="btn btn-primary">
                Continue Shopping
            </a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        @foreach (var item in Model)
                        {
                            <div class="row align-items-center mb-4 pb-4 border-bottom" data-item-id="@item.Product.Id" data-size="@item.Size" data-color="@item.Color">
                                <div class="col-md-2">
                                    <img src="@item.Product.ImageUrl" class="img-fluid rounded" alt="@item.Product.Name">
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-1">@item.Product.Name</h5>
                                    <p class="text-muted small mb-0">Size: @item.Size | Color: @item.Color</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <label class="d-block mb-2" style="font-size:14px;font-weight:700;color:#667eea;">
                                        Quantity
                                    </label>
                                    <div class="input-group justify-content-center" style="max-width: 150px; margin: 0 auto;">
                                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(@item.Product.Id, '@item.Size', '@item.Color', @(item.Quantity - 1))">-</button>
                                        <input type="number" class="form-control text-center" value="@item.Quantity" min="1" readonly>
                                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(@item.Product.Id, '@item.Size', '@item.Color', @(item.Quantity + 1))">+</button>
                                    </div>
                                </div>
                                <div class="col-md-2 text-center">
                                    <strong class="text-primary">@item.Subtotal.ToString("N0") EGP</strong>
                                </div>
                                <div class="col-md-1 text-end">
                                    <form asp-action="RemoveFromCart" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="productId" value="@item.Product.Id">
                                        <input type="hidden" name="size" value="@item.Size">
                                        <input type="hidden" name="color" value="@item.Color">
                                        <button type="submit" class="btn btn-link text-danger p-0">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Order Summary</h5>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Subtotal:</span>
                            <span>@totalPrice.ToString("N0") EGP</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>Shipping:</span>
                            <span class="text-muted">Free</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Total:</strong>
                            <strong class="text-primary fs-5">@totalPrice.ToString("N0") EGP</strong>
                        </div>
                        <form asp-action="ClearCart" method="post" class="mb-2">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash"></i> Clear Cart
                            </button>
                        </form>
                        <a asp-action="Checkout" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-check-circle"></i> Checkout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        function updateQuantity(productId, size, color, quantity) {
            if (quantity < 1) {
                if (confirm('Do you want to remove this product from the cart?')) {
                    removeFromCart(productId, size, color);
                }
                return;
            }

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Cart/UpdateQuantity';

            // Agregar token antifalsificación
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }

            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = 'productId';
            productIdInput.value = productId;

            const sizeInput = document.createElement('input');
            sizeInput.type = 'hidden';
            sizeInput.name = 'size';
            sizeInput.value = size;

            const colorInput = document.createElement('input');
            colorInput.type = 'hidden';
            colorInput.name = 'color';
            colorInput.value = color;

            const quantityInput = document.createElement('input');
            quantityInput.type = 'hidden';
            quantityInput.name = 'quantity';
            quantityInput.value = quantity;

            form.appendChild(productIdInput);
            form.appendChild(sizeInput);
            form.appendChild(colorInput);
            form.appendChild(quantityInput);

            document.body.appendChild(form);
            form.submit();
        }

        function removeFromCart(productId, size, color) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Cart/RemoveFromCart';

            // Agregar token antifalsificación
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }

            const productIdInput = document.createElement('input');
            productIdInput.type = 'hidden';
            productIdInput.name = 'productId';
            productIdInput.value = productId;

            const sizeInput = document.createElement('input');
            sizeInput.type = 'hidden';
            sizeInput.name = 'size';
            sizeInput.value = size;

            const colorInput = document.createElement('input');
            colorInput.type = 'hidden';
            colorInput.name = 'color';
            colorInput.value = color;

            form.appendChild(productIdInput);
            form.appendChild(sizeInput);
            form.appendChild(colorInput);

            document.body.appendChild(form);
            form.submit();
        }

    </script>
}

